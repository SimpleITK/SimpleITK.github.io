

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>DemonsRegistration2 &mdash; SimpleITK 1.2.0.dev documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script type="text/javascript" src="_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.js"></script>
        <script type="text/javascript" src="_static/sphinx_tabs/tabs.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" type="text/css" />
  <link rel="stylesheet" href="_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" type="text/css" />
  <link rel="stylesheet" href="_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" type="text/css" />
  <link rel="stylesheet" href="_static/sphinx_tabs/tabs.css" type="text/css" />
  <link rel="stylesheet" href="_static/style.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Read Image Meta-Data Dictionary and Print" href="link_DicomImagePrintTags_docs.html" />
    <link rel="prev" title="DemonsRegistration1" href="link_DemonsRegistration1_docs.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> SimpleITK
          

          
            
            <img src="_static/simpleitk_logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="fundamentalConcepts.html">Fundamental Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="registrationOverview.html">Registration Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="conventions.html">Common Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="IO.html">Reading and Writing for Images and Transforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="filters.html">SimpleITK Filters</a></li>
<li class="toctree-l1"><a class="reference internal" href="building.html">Building SimpleITK</a></li>
<li class="toctree-l1"><a class="reference internal" href="setUp.html">Setting Up Eclipse and Visual Studio</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorialsAndCourses.html">Tutorials and Courses</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="FilterTemplates.html">Developer</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="link_examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="link_HelloWorld_docs.html">Hello World</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_CSharp_docs.html">CSharp Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_DemonsRegistration1_docs.html">DemonsRegistration1</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">DemonsRegistration2</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#code">Code</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="link_DicomImagePrintTags_docs.html">Read Image Meta-Data Dictionary and Print</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_DicomSeriesReader_docs.html">Dicom Series Reader</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_DicomSeriesReadModifyWrite_docs.html">Dicom Series Read Modify Write</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_DicomSeriesFromArray_docs.html">Dicom Series From Array</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_FastMarchingSegmentation_docs.html">Fast Marching Segmentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_FilterProgressReporting_docs.html">Filter Progress Reporting</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_ImageGridManipulation_docs.html">Image Grid Manipulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_ImageRegistrationMethod1_docs.html">Image Registration Method 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_ImageRegistrationMethod2_docs.html">Image Registration Method 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_ImageRegistrationMethod3_docs.html">Image Registration Method 3</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_ImageRegistrationMethod4_docs.html">Image Registration Method 4</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_ImageRegistrationMethodBSpline1_docs.html">Image Registration Method BSpline 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_ImageRegistrationMethodBSpline2_docs.html">Image Registration Method BSpline 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_ImageRegistrationMethodBSpline3_docs.html">Image Registration Method BSpline 3</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_ImageRegistrationMethodDisplacement1_docs.html">Image Registration Method Displacement 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_ImageRegistrationMethodExhaustive_docs.html">Image Registration Method Exhaustive</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_ITKIntegration_docs.html">Integration with ITK</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_N4BiasFieldCorrection_docs.html">N4 Bias Field Correction</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_SimpleGaussian_docs.html">Reading-Gaussian Blurring-Writing</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_ImageViewing_docs.html">Image Viewing</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_AdvancedImageReading_docs.html">Advanced Image Reading</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_ImageIOSelection_docs.html">IO Selection for Image Reading</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">SimpleITK</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="link_examples.html">Examples</a> &raquo;</li>
        
      <li>DemonsRegistration2</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/link_DemonsRegistration2_docs.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="demonsregistration2">
<span id="lbl-demons-registration2"></span><h1>DemonsRegistration2<a class="headerlink" href="#demonsregistration2" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>This example illustrates how to use the <a class="reference external" href="https://itk.org/SimpleITKDoxygen/html/classitk_1_1simple_1_1FastSymmetricForcesDemonsRegistrationFilter.html">fast symmetric forces Demons algorithm</a>.
As the name implies, unlike the classical algorithm, the forces are symmetric.</p>
<p>The underlying assumption of the demons framework is that the intensities of
homologous points are equal. The example uses histogram matching to make the two
images similar prior to registration. This is relevant for registration of MR
images where the assumption is not valid. For other imaging modalities where the
assumption is valid, such as CT, this step is not necessary. Additionally, the
command design pattern is used to monitor registration progress. The resulting
deformation field is written to file.</p>
<p>See also: <a class="reference internal" href="link_DemonsRegistration1_docs.html#lbl-demons-registration1"><span class="std std-ref">DemonsRegistration1</span></a>.</p>
</div>
<div class="section" id="code">
<h2>Code<a class="headerlink" href="#code" title="Permalink to this headline">¶</a></h2>
<div class="sphinx-tabs docutils container">
<div class="ui top attached tabular menu sphinx-menu docutils container">
<div class="active item sphinx-data-tab-0-0 docutils container">
<div class="docutils container">
C++</div>
</div>
<div class="item sphinx-data-tab-0-1 docutils container">
<div class="docutils container">
Python</div>
</div>
<div class="item sphinx-data-tab-0-2 docutils container">
<div class="docutils container">
R</div>
</div>
</div>
<div class="ui bottom attached sphinx-tab tab segment sphinx-data-tab-0-0 active docutils container">
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// This example is based on ITK&#39;s DeformableRegistration2.cxx example</span>


<span class="cp">#include</span> <span class="cpf">&lt;SimpleITK.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;iomanip&gt;</span><span class="cp"></span>

<span class="k">namespace</span> <span class="n">sitk</span> <span class="o">=</span> <span class="n">itk</span><span class="o">::</span><span class="n">simple</span><span class="p">;</span>


<span class="k">class</span> <span class="nc">IterationUpdate</span>
  <span class="o">:</span> <span class="k">public</span> <span class="n">sitk</span><span class="o">::</span><span class="n">Command</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">IterationUpdate</span><span class="p">(</span> <span class="k">const</span> <span class="n">sitk</span><span class="o">::</span><span class="n">FastSymmetricForcesDemonsRegistrationFilter</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">m_Filter</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="p">{}</span>

  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">Execute</span><span class="p">(</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="c1">// use sitk&#39;s output operator for std::vector etc..</span>
      <span class="k">using</span> <span class="n">sitk</span><span class="o">::</span><span class="k">operator</span><span class="o">&lt;&lt;</span><span class="p">;</span>

      <span class="c1">// stash the stream state</span>
      <span class="n">std</span><span class="o">::</span><span class="n">ios</span>  <span class="n">state</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
      <span class="n">state</span><span class="p">.</span><span class="n">copyfmt</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">);</span>
      <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">fixed</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">setfill</span><span class="p">(</span><span class="sc">&#39; &#39;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">setprecision</span><span class="p">(</span> <span class="mi">5</span> <span class="p">);</span>
      <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">setw</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">m_Filter</span><span class="p">.</span><span class="n">GetElapsedIterations</span><span class="p">();</span>
      <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; = &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">setw</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">m_Filter</span><span class="p">.</span><span class="n">GetMetric</span><span class="p">();</span>
      <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

      <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">.</span><span class="n">copyfmt</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
    <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="k">const</span> <span class="n">sitk</span><span class="o">::</span><span class="n">FastSymmetricForcesDemonsRegistrationFilter</span> <span class="o">&amp;</span><span class="n">m_Filter</span><span class="p">;</span>

<span class="p">};</span>



<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>

  <span class="k">if</span> <span class="p">(</span> <span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="p">)</span>
    <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Usage: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &lt;fixedImageFilter&gt; &lt;movingImageFile&gt; [initialTransformFile] &lt;outputTransformFile&gt;&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="n">sitk</span><span class="o">::</span><span class="n">Image</span> <span class="n">fixed</span> <span class="o">=</span> <span class="n">sitk</span><span class="o">::</span><span class="n">ReadImage</span><span class="p">(</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">);</span>

  <span class="n">sitk</span><span class="o">::</span><span class="n">Image</span> <span class="n">moving</span> <span class="o">=</span> <span class="n">sitk</span><span class="o">::</span><span class="n">ReadImage</span><span class="p">(</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">);</span>

  <span class="n">sitk</span><span class="o">::</span><span class="n">HistogramMatchingImageFilter</span> <span class="n">matcher</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">fixed</span><span class="p">.</span><span class="n">GetPixelID</span><span class="p">()</span> <span class="o">==</span> <span class="n">sitk</span><span class="o">::</span><span class="n">sitkUInt8</span>
       <span class="o">||</span> <span class="n">fixed</span><span class="p">.</span><span class="n">GetPixelID</span><span class="p">()</span> <span class="o">==</span> <span class="n">sitk</span><span class="o">::</span><span class="n">sitkInt8</span> <span class="p">)</span>
    <span class="p">{</span>
    <span class="n">matcher</span><span class="p">.</span><span class="n">SetNumberOfHistogramLevels</span><span class="p">(</span> <span class="mi">128</span> <span class="p">);</span>
    <span class="p">}</span>
  <span class="k">else</span>
    <span class="p">{</span>
    <span class="n">matcher</span><span class="p">.</span><span class="n">SetNumberOfHistogramLevels</span><span class="p">(</span> <span class="mi">1024</span> <span class="p">);</span>
    <span class="p">}</span>
  <span class="n">matcher</span><span class="p">.</span><span class="n">SetNumberOfMatchPoints</span><span class="p">(</span> <span class="mi">7</span> <span class="p">);</span>
  <span class="n">matcher</span><span class="p">.</span><span class="n">ThresholdAtMeanIntensityOn</span><span class="p">();</span>

  <span class="n">moving</span> <span class="o">=</span> <span class="n">matcher</span><span class="p">.</span><span class="n">Execute</span><span class="p">(</span><span class="n">moving</span><span class="p">,</span> <span class="n">fixed</span><span class="p">);</span>

  <span class="n">sitk</span><span class="o">::</span><span class="n">FastSymmetricForcesDemonsRegistrationFilter</span> <span class="n">filter</span><span class="p">;</span>

  <span class="n">IterationUpdate</span> <span class="n">cmd</span><span class="p">(</span><span class="n">filter</span><span class="p">);</span>
  <span class="n">filter</span><span class="p">.</span><span class="n">AddCommand</span><span class="p">(</span> <span class="n">sitk</span><span class="o">::</span><span class="n">sitkIterationEvent</span><span class="p">,</span> <span class="n">cmd</span> <span class="p">);</span>

  <span class="n">filter</span><span class="p">.</span><span class="n">SetNumberOfIterations</span><span class="p">(</span> <span class="mi">200</span> <span class="p">);</span>
  <span class="n">filter</span><span class="p">.</span><span class="n">SetStandardDeviations</span><span class="p">(</span> <span class="mf">1.0</span> <span class="p">);</span>

  <span class="n">sitk</span><span class="o">::</span><span class="n">Image</span> <span class="n">displacementField</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span> <span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="p">)</span>
    <span class="p">{</span>

    <span class="n">sitk</span><span class="o">::</span><span class="n">Transform</span> <span class="n">initialTransform</span> <span class="o">=</span> <span class="n">sitk</span><span class="o">::</span><span class="n">ReadTransform</span><span class="p">(</span> <span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="p">);</span>
    <span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
    <span class="o">--</span><span class="n">argc</span><span class="p">;</span>

    <span class="n">sitk</span><span class="o">::</span><span class="n">TransformToDisplacementFieldFilter</span> <span class="n">toDisplacementFilter</span><span class="p">;</span>
    <span class="n">toDisplacementFilter</span><span class="p">.</span><span class="n">SetReferenceImage</span><span class="p">(</span><span class="n">fixed</span><span class="p">);</span>
    <span class="n">displacementField</span> <span class="o">=</span> <span class="n">toDisplacementFilter</span><span class="p">.</span><span class="n">Execute</span><span class="p">(</span><span class="n">initialTransform</span><span class="p">);</span>
    <span class="n">displacementField</span> <span class="o">=</span> <span class="n">filter</span><span class="p">.</span><span class="n">Execute</span><span class="p">(</span> <span class="n">fixed</span><span class="p">,</span> <span class="n">moving</span><span class="p">,</span> <span class="n">displacementField</span> <span class="p">);</span>
    <span class="p">}</span>
  <span class="k">else</span>
    <span class="p">{</span>
    <span class="n">displacementField</span> <span class="o">=</span> <span class="n">filter</span><span class="p">.</span><span class="n">Execute</span><span class="p">(</span> <span class="n">fixed</span><span class="p">,</span> <span class="n">moving</span> <span class="p">);</span>
    <span class="p">}</span>

  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;-------&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Number Of Iterations: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">filter</span><span class="p">.</span><span class="n">GetElapsedIterations</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; RMS: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">filter</span><span class="p">.</span><span class="n">GetRMSChange</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

  <span class="n">sitk</span><span class="o">::</span><span class="n">DisplacementFieldTransform</span> <span class="n">outTx</span><span class="p">(</span> <span class="n">displacementField</span> <span class="p">);</span>

  <span class="n">sitk</span><span class="o">::</span><span class="n">WriteTransform</span><span class="p">(</span><span class="n">outTx</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="ui bottom attached sphinx-tab tab segment sphinx-data-tab-0-1 docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">SimpleITK</span> <span class="kn">as</span> <span class="nn">sitk</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>


<span class="k">def</span> <span class="nf">command_iteration</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span> <span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;{0:3} = {1:10.5f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">filter</span><span class="o">.</span><span class="n">GetElapsedIterations</span><span class="p">(),</span>
                                    <span class="nb">filter</span><span class="o">.</span><span class="n">GetMetric</span><span class="p">()))</span>

<span class="k">if</span> <span class="nb">len</span> <span class="p">(</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span> <span class="s2">&quot;Usage: {0} &lt;fixedImageFilter&gt; &lt;movingImageFile&gt; [initialTransformFile] &lt;outputTransformFile&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>


<span class="n">fixed</span> <span class="o">=</span> <span class="n">sitk</span><span class="o">.</span><span class="n">ReadImage</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">moving</span> <span class="o">=</span> <span class="n">sitk</span><span class="o">.</span><span class="n">ReadImage</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

<span class="n">matcher</span> <span class="o">=</span> <span class="n">sitk</span><span class="o">.</span><span class="n">HistogramMatchingImageFilter</span><span class="p">()</span>
<span class="k">if</span> <span class="p">(</span> <span class="n">fixed</span><span class="o">.</span><span class="n">GetPixelID</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span> <span class="n">sitk</span><span class="o">.</span><span class="n">sitkUInt8</span><span class="p">,</span> <span class="n">sitk</span><span class="o">.</span><span class="n">sitkInt8</span> <span class="p">)</span> <span class="p">):</span>
    <span class="n">matcher</span><span class="o">.</span><span class="n">SetNumberOfHistogramLevels</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">matcher</span><span class="o">.</span><span class="n">SetNumberOfHistogramLevels</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="n">matcher</span><span class="o">.</span><span class="n">SetNumberOfMatchPoints</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="n">matcher</span><span class="o">.</span><span class="n">ThresholdAtMeanIntensityOn</span><span class="p">()</span>
<span class="n">moving</span> <span class="o">=</span> <span class="n">matcher</span><span class="o">.</span><span class="n">Execute</span><span class="p">(</span><span class="n">moving</span><span class="p">,</span><span class="n">fixed</span><span class="p">)</span>

<span class="c1"># The fast symmetric forces Demons Registration Filter</span>
<span class="c1"># Note there is a whole family of Demons Registration algorithms included in SimpleITK</span>
<span class="n">demons</span> <span class="o">=</span> <span class="n">sitk</span><span class="o">.</span><span class="n">FastSymmetricForcesDemonsRegistrationFilter</span><span class="p">()</span>
<span class="n">demons</span><span class="o">.</span><span class="n">SetNumberOfIterations</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
<span class="c1"># Standard deviation for Gaussian smoothing of displacement field</span>
<span class="n">demons</span><span class="o">.</span><span class="n">SetStandardDeviations</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

<span class="n">demons</span><span class="o">.</span><span class="n">AddCommand</span><span class="p">(</span> <span class="n">sitk</span><span class="o">.</span><span class="n">sitkIterationEvent</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">command_iteration</span><span class="p">(</span><span class="n">demons</span><span class="p">)</span> <span class="p">)</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
    <span class="n">initialTransform</span> <span class="o">=</span> <span class="n">sitk</span><span class="o">.</span><span class="n">ReadTransform</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="n">toDisplacementFilter</span> <span class="o">=</span> <span class="n">sitk</span><span class="o">.</span><span class="n">TransformToDisplacementFieldFilter</span><span class="p">()</span>
    <span class="n">toDisplacementFilter</span><span class="o">.</span><span class="n">SetReferenceImage</span><span class="p">(</span><span class="n">fixed</span><span class="p">)</span>

    <span class="n">displacementField</span> <span class="o">=</span> <span class="n">toDisplacementFilter</span><span class="o">.</span><span class="n">Execute</span><span class="p">(</span><span class="n">initialTransform</span><span class="p">)</span>

    <span class="n">displacementField</span> <span class="o">=</span> <span class="n">demons</span><span class="o">.</span><span class="n">Execute</span><span class="p">(</span><span class="n">fixed</span><span class="p">,</span> <span class="n">moving</span><span class="p">,</span> <span class="n">displacementField</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>

    <span class="n">displacementField</span> <span class="o">=</span> <span class="n">demons</span><span class="o">.</span><span class="n">Execute</span><span class="p">(</span><span class="n">fixed</span><span class="p">,</span> <span class="n">moving</span><span class="p">)</span>


<span class="k">print</span><span class="p">(</span><span class="s2">&quot;-------&quot;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot;Number Of Iterations: {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">demons</span><span class="o">.</span><span class="n">GetElapsedIterations</span><span class="p">()))</span>
<span class="k">print</span><span class="p">(</span><span class="s2">&quot; RMS: {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">demons</span><span class="o">.</span><span class="n">GetRMSChange</span><span class="p">()))</span>

<span class="n">outTx</span> <span class="o">=</span> <span class="n">sitk</span><span class="o">.</span><span class="n">DisplacementFieldTransform</span><span class="p">(</span><span class="n">displacementField</span><span class="p">)</span>

<span class="n">sitk</span><span class="o">.</span><span class="n">WriteTransform</span><span class="p">(</span><span class="n">outTx</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

<span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="s2">&quot;SITK_NOSHOW&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">):</span>

    <span class="n">resampler</span> <span class="o">=</span> <span class="n">sitk</span><span class="o">.</span><span class="n">ResampleImageFilter</span><span class="p">()</span>
    <span class="n">resampler</span><span class="o">.</span><span class="n">SetReferenceImage</span><span class="p">(</span><span class="n">fixed</span><span class="p">);</span>
    <span class="n">resampler</span><span class="o">.</span><span class="n">SetInterpolator</span><span class="p">(</span><span class="n">sitk</span><span class="o">.</span><span class="n">sitkLinear</span><span class="p">)</span>
    <span class="n">resampler</span><span class="o">.</span><span class="n">SetDefaultPixelValue</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">resampler</span><span class="o">.</span><span class="n">SetTransform</span><span class="p">(</span><span class="n">outTx</span><span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">resampler</span><span class="o">.</span><span class="n">Execute</span><span class="p">(</span><span class="n">moving</span><span class="p">)</span>
    <span class="n">simg1</span> <span class="o">=</span> <span class="n">sitk</span><span class="o">.</span><span class="n">Cast</span><span class="p">(</span><span class="n">sitk</span><span class="o">.</span><span class="n">RescaleIntensity</span><span class="p">(</span><span class="n">fixed</span><span class="p">),</span> <span class="n">sitk</span><span class="o">.</span><span class="n">sitkUInt8</span><span class="p">)</span>
    <span class="n">simg2</span> <span class="o">=</span> <span class="n">sitk</span><span class="o">.</span><span class="n">Cast</span><span class="p">(</span><span class="n">sitk</span><span class="o">.</span><span class="n">RescaleIntensity</span><span class="p">(</span><span class="n">out</span><span class="p">),</span> <span class="n">sitk</span><span class="o">.</span><span class="n">sitkUInt8</span><span class="p">)</span>
    <span class="n">cimg</span> <span class="o">=</span> <span class="n">sitk</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span><span class="n">simg1</span><span class="p">,</span> <span class="n">simg2</span><span class="p">,</span> <span class="n">simg1</span><span class="o">//</span><span class="mf">2.</span><span class="o">+</span><span class="n">simg2</span><span class="o">//</span><span class="mf">2.</span><span class="p">)</span>
    <span class="n">sitk</span><span class="o">.</span><span class="n">Show</span><span class="p">(</span> <span class="n">cimg</span><span class="p">,</span> <span class="s2">&quot;DeformableRegistration1 Composition&quot;</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="ui bottom attached sphinx-tab tab segment sphinx-data-tab-0-2 docutils container">
<div class="highlight-R notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run with:</span>
<span class="c1">#</span>
<span class="c1"># Rscript --vanilla DemonsRegistration2.R fixedImageFilter movingImageFile [initialTransformFile] outputTransformFile</span>
<span class="c1">#</span>

<span class="nf">library</span><span class="p">(</span><span class="n">SimpleITK</span><span class="p">)</span>

<span class="n">commandIteration</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">filter</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">msg</span> <span class="o">&lt;-</span> <span class="nf">paste</span><span class="p">(</span><span class="s">&quot;Iteration number &quot;</span><span class="p">,</span> <span class="n">filter</span><span class="o">$</span><span class="nf">GetElapsedIterations</span><span class="p">(),</span>
                 <span class="s">&quot; = &quot;</span><span class="p">,</span> <span class="n">filter</span><span class="o">$</span><span class="nf">GetMetric</span><span class="p">(),</span> <span class="s">&quot;\n&quot;</span> <span class="p">)</span>
    <span class="nf">cat</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">args</span> <span class="o">&lt;-</span> <span class="nf">commandArgs</span><span class="p">(</span> <span class="kc">TRUE</span> <span class="p">)</span>

<span class="nf">if </span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="m">3</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">stop</span><span class="p">(</span><span class="s">&quot;3 (or 4) arguments expected - fixedImageFilter, movingImageFile, [initialTransformFile], outputTransformFile&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">fixed</span> <span class="o">&lt;-</span> <span class="nf">ReadImage</span><span class="p">(</span><span class="n">args[[1]]</span><span class="p">)</span>

<span class="n">moving</span> <span class="o">&lt;-</span> <span class="nf">ReadImage</span><span class="p">(</span><span class="n">args[[2]]</span><span class="p">)</span>

<span class="n">matcher</span> <span class="o">&lt;-</span> <span class="nf">HistogramMatchingImageFilter</span><span class="p">()</span>
<span class="nf">if </span><span class="p">(</span> <span class="n">fixed</span><span class="o">$</span><span class="nf">GetPixelID</span><span class="p">()</span> <span class="o">%in%</span> <span class="nf">c</span><span class="p">(</span> <span class="s">&#39;sitkUInt8&#39;</span><span class="p">,</span> <span class="s">&#39;sitkInt8&#39;</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
    <span class="n">matcher</span><span class="o">$</span><span class="nf">SetNumberOfHistogramLevels</span><span class="p">(</span><span class="m">128</span><span class="p">)</span>
<span class="p">}</span> <span class="n">else</span> <span class="p">{</span>
    <span class="n">matcher</span><span class="o">$</span><span class="nf">SetNumberOfHistogramLevels</span><span class="p">(</span><span class="m">1024</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">matcher</span><span class="o">$</span><span class="nf">SetNumberOfMatchPoints</span><span class="p">(</span><span class="m">7</span><span class="p">)</span>
<span class="n">matcher</span><span class="o">$</span><span class="nf">ThresholdAtMeanIntensityOn</span><span class="p">()</span>
<span class="n">moving</span> <span class="o">&lt;-</span> <span class="n">matcher</span><span class="o">$</span><span class="nf">Execute</span><span class="p">(</span><span class="n">moving</span><span class="p">,</span> <span class="n">fixed</span><span class="p">)</span>

<span class="c1"># The fast symmetric forces Demons Registration Filter</span>
<span class="c1"># Note there is a whole family of Demons Registration algorithms included in SimpleITK</span>
<span class="n">demons</span> <span class="o">&lt;-</span> <span class="nf">FastSymmetricForcesDemonsRegistrationFilter</span><span class="p">()</span>
<span class="n">demons</span><span class="o">$</span><span class="nf">SetNumberOfIterations</span><span class="p">(</span><span class="m">200</span><span class="p">)</span>
<span class="c1"># Standard deviation for Gaussian smoothing of displacement field</span>
<span class="n">demons</span><span class="o">$</span><span class="nf">SetStandardDeviations</span><span class="p">(</span><span class="m">1.0</span><span class="p">)</span>

<span class="n">demons</span><span class="o">$</span><span class="nf">AddCommand</span><span class="p">(</span> <span class="s">&#39;sitkIterationEvent&#39;</span><span class="p">,</span> <span class="nf">function</span><span class="p">()</span> <span class="nf">commandIteration</span><span class="p">(</span><span class="n">demons</span><span class="p">)</span> <span class="p">)</span>


<span class="nf">if </span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="m">3</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">initialTransform</span> <span class="o">&lt;-</span> <span class="nf">ReadTransform</span><span class="p">(</span><span class="n">args[[3]]</span><span class="p">)</span>

    <span class="n">toDisplacementFilter</span> <span class="o">&lt;-</span> <span class="nf">TransformToDisplacementFieldFilter</span><span class="p">()</span>
    <span class="n">toDisplacementFilter</span><span class="o">$</span><span class="nf">SetReferenceImage</span><span class="p">(</span><span class="n">fixed</span><span class="p">)</span>

    <span class="n">displacementField</span> <span class="o">&lt;-</span> <span class="n">toDisplacementFilter</span><span class="o">$</span><span class="nf">Execute</span><span class="p">(</span><span class="n">initialTransform</span><span class="p">)</span>

    <span class="n">displacementField</span> <span class="o">&lt;-</span> <span class="n">demons</span><span class="o">$</span><span class="nf">Execute</span><span class="p">(</span><span class="n">fixed</span><span class="p">,</span> <span class="n">moving</span><span class="p">,</span> <span class="n">displacementField</span><span class="p">)</span>
<span class="p">}</span> <span class="n">else</span> <span class="p">{</span>
    <span class="n">displacementField</span> <span class="o">&lt;-</span> <span class="n">demons</span><span class="o">$</span><span class="nf">Execute</span><span class="p">(</span><span class="n">fixed</span><span class="p">,</span> <span class="n">moving</span><span class="p">)</span>
<span class="p">}</span>


<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;-------\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot;Number Of Iterations: &quot;</span><span class="p">,</span><span class="n">demons</span><span class="o">$</span><span class="nf">GetElapsedIterations</span><span class="p">(),</span> <span class="s">&quot;\n&quot;</span><span class="p">)</span>
<span class="nf">cat</span><span class="p">(</span><span class="s">&quot; RMS: &quot;</span><span class="p">,</span> <span class="n">demons</span><span class="o">$</span><span class="nf">GetRMSChange</span><span class="p">(),</span> <span class="s">&quot;\n&quot;</span><span class="p">)</span>

<span class="n">outTx</span> <span class="o">&lt;-</span> <span class="nf">DisplacementFieldTransform</span><span class="p">(</span><span class="n">displacementField</span><span class="p">)</span>

<span class="nf">WriteTransform</span><span class="p">(</span><span class="n">outTx</span><span class="p">,</span> <span class="nf">tail</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="m">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="link_DicomImagePrintTags_docs.html" class="btn btn-neutral float-right" title="Read Image Meta-Data Dictionary and Print" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="link_DemonsRegistration1_docs.html" class="btn btn-neutral float-left" title="DemonsRegistration1" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Insight Software Consortium

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>