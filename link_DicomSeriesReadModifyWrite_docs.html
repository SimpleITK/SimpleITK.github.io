

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Dicom Series Read Modify Write &mdash; SimpleITK 1.2.0.dev documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script type="text/javascript" src="_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.js"></script>
        <script type="text/javascript" src="_static/sphinx_tabs/tabs.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" type="text/css" />
  <link rel="stylesheet" href="_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" type="text/css" />
  <link rel="stylesheet" href="_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" type="text/css" />
  <link rel="stylesheet" href="_static/sphinx_tabs/tabs.css" type="text/css" />
  <link rel="stylesheet" href="_static/style.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Dicom Series From Array" href="link_DicomSeriesFromArray_docs.html" />
    <link rel="prev" title="Dicom Series Reader" href="link_DicomSeriesReader_docs.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> SimpleITK
          

          
            
            <img src="_static/simpleitk_logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="fundamentalConcepts.html">Fundamental Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="registrationOverview.html">Registration Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="conventions.html">Common Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="IO.html">Reading and Writing for Images and Transforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="filters.html">SimpleITK Filters</a></li>
<li class="toctree-l1"><a class="reference internal" href="building.html">Building SimpleITK</a></li>
<li class="toctree-l1"><a class="reference internal" href="setUp.html">Setting Up Eclipse and Visual Studio</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorialsAndCourses.html">Tutorials and Courses</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="FilterTemplates.html">Developer</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="link_examples.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="link_HelloWorld_docs.html">Hello World</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_CSharp_docs.html">CSharp Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_DemonsRegistration1_docs.html">DemonsRegistration1</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_DemonsRegistration2_docs.html">DemonsRegistration2</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_DicomImagePrintTags_docs.html">Read Image Meta-Data Dictionary and Print</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_DicomSeriesReader_docs.html">Dicom Series Reader</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Dicom Series Read Modify Write</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#code">Code</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="link_DicomSeriesFromArray_docs.html">Dicom Series From Array</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_FastMarchingSegmentation_docs.html">Fast Marching Segmentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_FilterProgressReporting_docs.html">Filter Progress Reporting</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_ImageGridManipulation_docs.html">Image Grid Manipulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_ImageRegistrationMethod1_docs.html">Image Registration Method 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_ImageRegistrationMethod2_docs.html">Image Registration Method 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_ImageRegistrationMethod3_docs.html">Image Registration Method 3</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_ImageRegistrationMethod4_docs.html">Image Registration Method 4</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_ImageRegistrationMethodBSpline1_docs.html">Image Registration Method BSpline 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_ImageRegistrationMethodBSpline2_docs.html">Image Registration Method BSpline 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_ImageRegistrationMethodBSpline3_docs.html">Image Registration Method BSpline 3</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_ImageRegistrationMethodDisplacement1_docs.html">Image Registration Method Displacement 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_ImageRegistrationMethodExhaustive_docs.html">Image Registration Method Exhaustive</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_ITKIntegration_docs.html">Integration with ITK</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_N4BiasFieldCorrection_docs.html">N4 Bias Field Correction</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_SimpleGaussian_docs.html">Reading-Gaussian Blurring-Writing</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_ImageViewing_docs.html">Image Viewing</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_AdvancedImageReading_docs.html">Advanced Image Reading</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_ImageIOSelection_docs.html">IO Selection for Image Reading</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">SimpleITK</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="link_examples.html">Examples</a> &raquo;</li>
        
      <li>Dicom Series Read Modify Write</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/link_DicomSeriesReadModifyWrite_docs.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="dicom-series-read-modify-write">
<span id="lbl-dicom-series-read-modify-write"></span><h1>Dicom Series Read Modify Write<a class="headerlink" href="#dicom-series-read-modify-write" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>This example illustrates how to read a DICOM series, modify the 3D image, and then write the result as a DICOM series.</p>
<p>Reading the DICOM series is a three step process: first obtain the series ID, then obtain the file names associated with the series ID, and finally use the series reader to read the images. By default the DICOM meta-data dicitonary for each of the slices is not read. In this example we configure the series reader to load the meta-data dictionary including all of the private tags.</p>
<p>Modifying the 3D image can involve changes to its physical charecteristics (spacing, direction cosines) and its intensities. In our case we only modify the intensities by blurring the image.</p>
<p>Writing the 3D image as a DICOM series is done by configuring the meta-data dictionary for each of the slices and then writing it in DICOM format. In our case we copy some of the meta-data from the original dictionaries which are available from the series reader. We then set some additional meta-data values to indicate that this series is derived from the original acquired data. Note that we write the intensity values as is and thus do not set the rescale slope (0028|1053), rescale intercept (0028|1052) meta-data dictionary values.</p>
<p>See also <a class="reference internal" href="link_DicomImagePrintTags_docs.html#lbl-print-image-meta-data-dictionary"><span class="std std-ref">Read Image Meta-Data Dictionary and Print</span></a>, <a class="reference internal" href="link_DicomSeriesReader_docs.html#lbl-dicom-series-reader"><span class="std std-ref">Dicom Series Reader</span></a>.</p>
</div>
<div class="section" id="code">
<h2>Code<a class="headerlink" href="#code" title="Permalink to this headline">¶</a></h2>
<div class="sphinx-tabs docutils container">
<div class="ui top attached tabular menu sphinx-menu docutils container">
<div class="active item sphinx-data-tab-0-0 docutils container">
<div class="docutils container">
Python</div>
</div>
<div class="item sphinx-data-tab-0-1 docutils container">
<div class="docutils container">
R</div>
</div>
</div>
<div class="ui bottom attached sphinx-tab tab segment sphinx-data-tab-0-0 active docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">SimpleITK</span> <span class="kn">as</span> <span class="nn">sitk</span>

<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">os</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span> <span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span> <span class="s2">&quot;Usage: python &quot;</span> <span class="o">+</span> <span class="vm">__file__</span> <span class="o">+</span> <span class="s2">&quot; &lt;input_directory_with_DICOM_series&gt; &lt;output_directory&gt;&quot;</span> <span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span> <span class="p">(</span> <span class="mi">1</span> <span class="p">)</span>


<span class="c1"># Read the original series. First obtain the series file names using the</span>
<span class="c1"># image series reader.</span>
<span class="n">data_directory</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">series_IDs</span> <span class="o">=</span> <span class="n">sitk</span><span class="o">.</span><span class="n">ImageSeriesReader</span><span class="o">.</span><span class="n">GetGDCMSeriesIDs</span><span class="p">(</span><span class="n">data_directory</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">series_IDs</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;ERROR: given directory </span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">+</span><span class="n">data_directory</span><span class="o">+</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2"> does not contain a DICOM series.&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">series_file_names</span> <span class="o">=</span> <span class="n">sitk</span><span class="o">.</span><span class="n">ImageSeriesReader</span><span class="o">.</span><span class="n">GetGDCMSeriesFileNames</span><span class="p">(</span><span class="n">data_directory</span><span class="p">,</span> <span class="n">series_IDs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">series_reader</span> <span class="o">=</span> <span class="n">sitk</span><span class="o">.</span><span class="n">ImageSeriesReader</span><span class="p">()</span>
<span class="n">series_reader</span><span class="o">.</span><span class="n">SetFileNames</span><span class="p">(</span><span class="n">series_file_names</span><span class="p">)</span>

<span class="c1"># Configure the reader to load all of the DICOM tags (public+private):</span>
<span class="c1"># By default tags are not loaded (saves time).</span>
<span class="c1"># By default if tags are loaded, the private tags are not loaded.</span>
<span class="c1"># We explicitly configure the reader to load tags, including the</span>
<span class="c1"># private ones.</span>
<span class="n">series_reader</span><span class="o">.</span><span class="n">MetaDataDictionaryArrayUpdateOn</span><span class="p">()</span>
<span class="n">series_reader</span><span class="o">.</span><span class="n">LoadPrivateTagsOn</span><span class="p">()</span>
<span class="n">image3D</span> <span class="o">=</span> <span class="n">series_reader</span><span class="o">.</span><span class="n">Execute</span><span class="p">()</span>

<span class="c1"># Modify the image (blurring)</span>
<span class="n">filtered_image</span> <span class="o">=</span> <span class="n">sitk</span><span class="o">.</span><span class="n">DiscreteGaussian</span><span class="p">(</span><span class="n">image3D</span><span class="p">)</span>

<span class="c1"># Write the 3D image as a series</span>
<span class="c1"># IMPORTANT: There are many DICOM tags that need to be updated when you modify an</span>
<span class="c1">#            original image. This is a delicate opration and requires knowlege of</span>
<span class="c1">#            the DICOM standard. This example only modifies some. For a more complete</span>
<span class="c1">#            list of tags that need to be modified see:</span>
<span class="c1">#                           http://gdcm.sourceforge.net/wiki/index.php/Writing_DICOM</span>

<span class="n">writer</span> <span class="o">=</span> <span class="n">sitk</span><span class="o">.</span><span class="n">ImageFileWriter</span><span class="p">()</span>
<span class="c1"># Use the study/series/frame of reference information given in the meta-data</span>
<span class="c1"># dictionary and not the automatically generated information from the file IO</span>
<span class="n">writer</span><span class="o">.</span><span class="n">KeepOriginalImageUIDOn</span><span class="p">()</span>

<span class="c1"># Copy relevant tags from the original meta-data dictionary (private tags are also</span>
<span class="c1"># accessible).</span>
<span class="n">tags_to_copy</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;0010|0010&quot;</span><span class="p">,</span> <span class="c1"># Patient Name</span>
                <span class="s2">&quot;0010|0020&quot;</span><span class="p">,</span> <span class="c1"># Patient ID</span>
                <span class="s2">&quot;0010|0030&quot;</span><span class="p">,</span> <span class="c1"># Patient Birth Date</span>
                <span class="s2">&quot;0020|000D&quot;</span><span class="p">,</span> <span class="c1"># Study Instance UID, for machine consumption</span>
                <span class="s2">&quot;0020|0010&quot;</span><span class="p">,</span> <span class="c1"># Study ID, for human consumption</span>
                <span class="s2">&quot;0008|0020&quot;</span><span class="p">,</span> <span class="c1"># Study Date</span>
                <span class="s2">&quot;0008|0030&quot;</span><span class="p">,</span> <span class="c1"># Study Time</span>
                <span class="s2">&quot;0008|0050&quot;</span><span class="p">,</span> <span class="c1"># Accession Number</span>
                <span class="s2">&quot;0008|0060&quot;</span>  <span class="c1"># Modality</span>
<span class="p">]</span>

<span class="n">modification_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H%M%S&quot;</span><span class="p">)</span>
<span class="n">modification_date</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Copy some of the tags and add the relevant tags indicating the change.</span>
<span class="c1"># For the series instance UID (0020|000e), each of the components is a number, cannot start</span>
<span class="c1"># with zero, and separated by a &#39;.&#39; We create a unique series ID using the date and time.</span>
<span class="c1"># tags of interest:</span>
<span class="n">direction</span> <span class="o">=</span> <span class="n">filtered_image</span><span class="o">.</span><span class="n">GetDirection</span><span class="p">()</span>
<span class="n">series_tag_values</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">series_reader</span><span class="o">.</span><span class="n">GetMetaData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">tags_to_copy</span> <span class="k">if</span> <span class="n">series_reader</span><span class="o">.</span><span class="n">HasMetaDataKey</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">k</span><span class="p">)]</span> <span class="o">+</span> \
                 <span class="p">[(</span><span class="s2">&quot;0008|0031&quot;</span><span class="p">,</span><span class="n">modification_time</span><span class="p">),</span> <span class="c1"># Series Time</span>
                  <span class="p">(</span><span class="s2">&quot;0008|0021&quot;</span><span class="p">,</span><span class="n">modification_date</span><span class="p">),</span> <span class="c1"># Series Date</span>
                  <span class="p">(</span><span class="s2">&quot;0008|0008&quot;</span><span class="p">,</span><span class="s2">&quot;DERIVED</span><span class="se">\\</span><span class="s2">SECONDARY&quot;</span><span class="p">),</span> <span class="c1"># Image Type</span>
                  <span class="p">(</span><span class="s2">&quot;0020|000e&quot;</span><span class="p">,</span> <span class="s2">&quot;1.2.826.0.1.3680043.2.1125.&quot;</span><span class="o">+</span><span class="n">modification_date</span><span class="o">+</span><span class="s2">&quot;.1&quot;</span><span class="o">+</span><span class="n">modification_time</span><span class="p">),</span> <span class="c1"># Series Instance UID</span>
                  <span class="p">(</span><span class="s2">&quot;0020|0037&quot;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="p">(</span><span class="n">direction</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">direction</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">direction</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="c1"># Image Orientation (Patient)</span>
                                                    <span class="n">direction</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">direction</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">direction</span><span class="p">[</span><span class="mi">7</span><span class="p">])))),</span>
                  <span class="p">(</span><span class="s2">&quot;0008|103e&quot;</span><span class="p">,</span> <span class="n">series_reader</span><span class="o">.</span><span class="n">GetMetaData</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s2">&quot;0008|103e&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; Processed-SimpleITK&quot;</span><span class="p">)]</span> <span class="c1"># Series Description</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">filtered_image</span><span class="o">.</span><span class="n">GetDepth</span><span class="p">()):</span>
    <span class="n">image_slice</span> <span class="o">=</span> <span class="n">filtered_image</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>
    <span class="c1"># Tags shared by the series.</span>
    <span class="k">for</span> <span class="n">tag</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">series_tag_values</span><span class="p">:</span>
        <span class="n">image_slice</span><span class="o">.</span><span class="n">SetMetaData</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="c1"># Slice specific tags.</span>
    <span class="n">image_slice</span><span class="o">.</span><span class="n">SetMetaData</span><span class="p">(</span><span class="s2">&quot;0008|0012&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">))</span> <span class="c1"># Instance Creation Date</span>
    <span class="n">image_slice</span><span class="o">.</span><span class="n">SetMetaData</span><span class="p">(</span><span class="s2">&quot;0008|0013&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H%M%S&quot;</span><span class="p">))</span> <span class="c1"># Instance Creation Time</span>
    <span class="n">image_slice</span><span class="o">.</span><span class="n">SetMetaData</span><span class="p">(</span><span class="s2">&quot;0020|0032&quot;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="n">filtered_image</span><span class="o">.</span><span class="n">TransformIndexToPhysicalPoint</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">)))))</span> <span class="c1"># Image Position (Patient)</span>
    <span class="n">image_slice</span><span class="o">.</span><span class="n">SetMetaData</span><span class="p">(</span><span class="s2">&quot;0020|0013&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="c1"># Instance Number</span>

    <span class="c1"># Write to the output directory and add the extension dcm, to force writing in DICOM format.</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">SetFileName</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.dcm&#39;</span><span class="p">))</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">Execute</span><span class="p">(</span><span class="n">image_slice</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span> <span class="mi">0</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="ui bottom attached sphinx-tab tab segment sphinx-data-tab-0-1 docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">SimpleITK</span><span class="p">)</span>

<span class="n">args</span> <span class="o">&lt;-</span> <span class="nf">commandArgs</span><span class="p">(</span> <span class="kc">TRUE</span> <span class="p">)</span>

<span class="nf">if </span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="m">2</span><span class="p">)</span> <span class="p">{</span>
   <span class="nf">write</span><span class="p">(</span><span class="s">&quot;Usage arguments: &lt;input_directory_with_DICOM_series&gt; &lt;output_directory&gt;&quot;</span><span class="p">,</span> <span class="nf">stderr</span><span class="p">())</span>
   <span class="nf">quit</span><span class="p">(</span><span class="n">save</span><span class="o">=</span><span class="s">&quot;no&quot;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Read the original series. First obtain the series file names using the</span>
<span class="c1"># image series reader.</span>
<span class="n">data_directory</span> <span class="o">&lt;-</span> <span class="n">args[1]</span>
<span class="n">series_IDs</span> <span class="o">&lt;-</span> <span class="nf">ImageSeriesReader_GetGDCMSeriesIDs</span><span class="p">(</span><span class="n">data_directory</span><span class="p">)</span>
<span class="nf">if</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">series_IDs</span><span class="p">)</span><span class="o">==</span><span class="m">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">write</span><span class="p">(</span><span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;ERROR: given directory \&quot;&quot;</span><span class="p">,</span><span class="n">data_directory</span><span class="p">,</span><span class="s">&quot;\&quot; does not contain a DICOM series.&quot;</span><span class="p">))</span>
    <span class="nf">quit</span><span class="p">(</span><span class="n">save</span><span class="o">=</span><span class="s">&quot;no&quot;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="m">1</span><span class="p">)</span>
<span class="p">}</span>
<span class="n">series_file_names</span> <span class="o">&lt;-</span> <span class="nf">ImageSeriesReader_GetGDCMSeriesFileNames</span><span class="p">(</span><span class="n">data_directory</span><span class="p">,</span> <span class="n">series_IDs[1]</span><span class="p">)</span>

<span class="n">series_reader</span> <span class="o">&lt;-</span> <span class="nf">ImageSeriesReader</span><span class="p">()</span>
<span class="n">series_reader</span><span class="o">$</span><span class="nf">SetFileNames</span><span class="p">(</span><span class="n">series_file_names</span><span class="p">)</span>

<span class="c1"># Configure the reader to load all of the DICOM tags (public+private):</span>
<span class="c1"># By default tags are not loaded (saves time).</span>
<span class="c1"># By default if tags are loaded, the private tags are not loaded.</span>
<span class="c1"># We explicitly configure the reader to load tags, including the</span>
<span class="c1"># private ones.</span>
<span class="n">series_reader</span><span class="o">$</span><span class="nf">MetaDataDictionaryArrayUpdateOn</span><span class="p">()</span>
<span class="n">series_reader</span><span class="o">$</span><span class="nf">LoadPrivateTagsOn</span><span class="p">()</span>
<span class="n">image3D</span> <span class="o">&lt;-</span> <span class="n">series_reader</span><span class="o">$</span><span class="nf">Execute</span><span class="p">()</span>

<span class="c1"># Modify the image (blurring)</span>
<span class="n">filtered_image</span> <span class="o">&lt;-</span> <span class="nf">DiscreteGaussian</span><span class="p">(</span><span class="n">image3D</span><span class="p">)</span>

<span class="c1"># Write the 3D image as a series</span>
<span class="c1"># IMPORTANT: There are many DICOM tags that need to be updated when you modify an</span>
<span class="c1">#            original image. This is a delicate opration and requires knowlege of</span>
<span class="c1">#            the DICOM standard. This example only modifies some. For a more complete</span>
<span class="c1">#            list of tags that need to be modified see:</span>
<span class="c1">#                           http://gdcm.sourceforge.net/wiki/index.php/Writing_DICOM</span>

<span class="n">writer</span> <span class="o">&lt;-</span> <span class="nf">ImageFileWriter</span><span class="p">()</span>
<span class="c1"># Use the study/series/frame of reference information given in the meta-data</span>
<span class="c1"># dictionary and not the automatically generated information from the file IO</span>
<span class="n">writer</span><span class="o">$</span><span class="nf">KeepOriginalImageUIDOn</span><span class="p">()</span>

<span class="c1"># Copy relevant tags from the original meta-data dictionary (private tags are also</span>
<span class="c1"># accessible).</span>
<span class="n">tags_to_copy</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;0010|0010&quot;</span><span class="p">,</span> <span class="c1"># Patient Name</span>
                <span class="s">&quot;0010|0020&quot;</span><span class="p">,</span> <span class="c1"># Patient ID</span>
                <span class="s">&quot;0010|0030&quot;</span><span class="p">,</span> <span class="c1"># Patient Birth Date</span>
                <span class="s">&quot;0020|000D&quot;</span><span class="p">,</span> <span class="c1"># Study Instance UID, for machine consumption</span>
                <span class="s">&quot;0020|0010&quot;</span><span class="p">,</span> <span class="c1"># Study ID, for human consumption</span>
                <span class="s">&quot;0008|0020&quot;</span><span class="p">,</span> <span class="c1"># Study Date</span>
                <span class="s">&quot;0008|0030&quot;</span><span class="p">,</span> <span class="c1"># Study Time</span>
                <span class="s">&quot;0008|0050&quot;</span><span class="p">,</span> <span class="c1"># Accession Number</span>
                <span class="s">&quot;0008|0060&quot;</span>  <span class="c1"># Modality</span>
<span class="p">)</span>

<span class="n">modification_time</span> <span class="o">&lt;-</span> <span class="nf">format</span><span class="p">(</span><span class="nf">Sys.time</span><span class="p">(),</span> <span class="s">&quot;%H%M%S&quot;</span><span class="p">)</span>
<span class="n">modification_date</span> <span class="o">&lt;-</span> <span class="nf">format</span><span class="p">(</span><span class="nf">Sys.time</span><span class="p">(),</span> <span class="s">&quot;%Y%m%d&quot;</span><span class="p">)</span>

<span class="c1"># Copy some of the tags and add the relevant tags indicating the change.</span>
<span class="c1"># When attempting to copy we are not ensured that the tags exist, in which case</span>
<span class="c1"># we get a NULL as an entry in the list returned by lapply, these are removed</span>
<span class="c1"># by the Filter.</span>
<span class="c1"># For the series instance UID (0020|000e), each of the components is a number, cannot start</span>
<span class="c1"># with zero, and separated by a &#39;.&#39; We create a unique series ID using the date and time.</span>
<span class="c1"># tags of interest:</span>
<span class="n">direction</span> <span class="o">&lt;-</span> <span class="n">filtered_image</span><span class="o">$</span><span class="nf">GetDirection</span><span class="p">()</span>
<span class="n">series_tag_values</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="nf">Filter</span><span class="p">(</span><span class="nf">Negate</span><span class="p">(</span><span class="n">is.null</span><span class="p">),</span>
                             <span class="nf">lapply</span><span class="p">(</span><span class="n">tags_to_copy</span><span class="p">,</span>
                             <span class="nf">function</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
                               <span class="nf">if</span><span class="p">(</span><span class="n">series_reader</span><span class="o">$</span><span class="nf">HasMetaDataKey</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="p">{</span>
                                 <span class="nf">list</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">series_reader</span><span class="o">$</span><span class="nf">GetMetaData</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
                                <span class="p">}</span>
                             <span class="p">})),</span>
                        <span class="nf">list</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="s">&quot;0008|0031&quot;</span><span class="p">,</span><span class="n">modification_time</span><span class="p">),</span> <span class="c1"># Series Time</span>
                             <span class="nf">list</span><span class="p">(</span><span class="s">&quot;0008|0021&quot;</span><span class="p">,</span><span class="n">modification_date</span><span class="p">),</span> <span class="c1"># Series Date</span>
                             <span class="nf">list</span><span class="p">(</span><span class="s">&quot;0008|0008&quot;</span><span class="p">,</span><span class="s">&quot;DERIVED\\SECONDARY&quot;</span><span class="p">),</span> <span class="c1"># Image Type</span>
                             <span class="nf">list</span><span class="p">(</span><span class="s">&quot;0020|000e&quot;</span><span class="p">,</span> <span class="nf">paste0</span><span class="p">(</span><span class="s">&quot;1.2.826.0.1.3680043.2.1125.&quot;</span><span class="p">,</span><span class="n">modification_date</span><span class="p">,</span><span class="s">&quot;.1&quot;</span><span class="p">,</span><span class="n">modification_time</span><span class="p">)),</span> <span class="c1"># Series Instance UID</span>
                             <span class="nf">list</span><span class="p">(</span><span class="s">&quot;0020|0037&quot;</span><span class="p">,</span> <span class="nf">paste</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">direction[1]</span><span class="p">,</span> <span class="n">direction[4]</span><span class="p">,</span> <span class="n">direction[7]</span><span class="p">,</span>
                                                       <span class="n">direction[2]</span><span class="p">,</span><span class="n">direction[5]</span><span class="p">,</span><span class="n">direction[8]</span><span class="p">),</span> <span class="n">collapse</span><span class="o">=</span><span class="s">&quot;\\&quot;</span><span class="p">)),</span> <span class="c1"># Image Orientation (Patient)</span>
                             <span class="nf">list</span><span class="p">(</span><span class="s">&quot;0008|103e&quot;</span><span class="p">,</span> <span class="nf">paste0</span><span class="p">(</span><span class="n">series_reader</span><span class="o">$</span><span class="nf">GetMetaData</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="s">&quot;0008|103e&quot;</span><span class="p">),</span> <span class="s">&quot; Processed-SimpleITK&quot;</span><span class="p">))))</span> <span class="c1"># Series Description</span>

<span class="nf">for</span><span class="p">(</span><span class="n">i</span> <span class="n">in</span> <span class="m">1</span><span class="o">:</span><span class="n">filtered_image</span><span class="o">$</span><span class="nf">GetDepth</span><span class="p">())</span> <span class="p">{</span>
  <span class="n">image_slice</span> <span class="o">&lt;-</span> <span class="n">filtered_image[</span><span class="p">,,</span><span class="n">i]</span>
  <span class="c1"># Tags shared by the series.</span>
  <span class="nf">invisible</span><span class="p">(</span><span class="nf">lapply</span><span class="p">(</span><span class="n">series_tag_values</span><span class="p">,</span>
                   <span class="nf">function</span><span class="p">(</span><span class="n">tag_value</span><span class="p">)</span> <span class="p">{</span><span class="n">image_slice</span><span class="o">$</span><span class="nf">SetMetaData</span><span class="p">(</span><span class="n">tag_value[1]</span><span class="p">,</span> <span class="n">tag_value[2]</span><span class="p">)}))</span>
  <span class="c1"># Slice specific tags.</span>
  <span class="n">image_slice</span><span class="o">$</span><span class="nf">SetMetaData</span><span class="p">(</span><span class="s">&quot;0008|0012&quot;</span><span class="p">,</span> <span class="nf">format</span><span class="p">(</span><span class="nf">Sys.time</span><span class="p">(),</span> <span class="s">&quot;%Y%m%d&quot;</span><span class="p">))</span> <span class="c1"># Instance Creation Date</span>
  <span class="n">image_slice</span><span class="o">$</span><span class="nf">SetMetaData</span><span class="p">(</span><span class="s">&quot;0008|0013&quot;</span><span class="p">,</span> <span class="nf">format</span><span class="p">(</span><span class="nf">Sys.time</span><span class="p">(),</span> <span class="s">&quot;%H%M%S&quot;</span><span class="p">))</span> <span class="c1"># Instance Creation Time</span>
  <span class="n">image_slice</span><span class="o">$</span><span class="nf">SetMetaData</span><span class="p">(</span><span class="s">&quot;0020|0032&quot;</span><span class="p">,</span> <span class="nf">paste</span><span class="p">(</span><span class="n">filtered_image</span><span class="o">$</span><span class="nf">TransformIndexToPhysicalPoint</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="n">i</span><span class="m">-1</span><span class="p">)),</span> <span class="n">collapse</span><span class="o">=</span><span class="s">&quot;\\&quot;</span><span class="p">))</span> <span class="c1"># Image Position (Patient)</span>
  <span class="n">image_slice</span><span class="o">$</span><span class="nf">SetMetaData</span><span class="p">(</span><span class="s">&quot;0020|0013&quot;</span><span class="p">,</span> <span class="nf">as.character</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="c1"># Instance Number</span>

  <span class="c1"># Write to the output directory and add the extension dcm, to force writing in DICOM format.</span>
  <span class="n">writer</span><span class="o">$</span><span class="nf">SetFileName</span><span class="p">(</span><span class="nf">file.path</span><span class="p">(</span><span class="n">args[[2]]</span><span class="p">,</span> <span class="nf">sprintf</span><span class="p">(</span><span class="s">&quot;%d.dcm&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">)))</span>
  <span class="n">writer</span><span class="o">$</span><span class="nf">Execute</span><span class="p">(</span><span class="n">image_slice</span><span class="p">)</span>
<span class="p">}</span>

<span class="nf">quit</span><span class="p">(</span><span class="n">save</span><span class="o">=</span><span class="s">&quot;no&quot;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="m">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="link_DicomSeriesFromArray_docs.html" class="btn btn-neutral float-right" title="Dicom Series From Array" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="link_DicomSeriesReader_docs.html" class="btn btn-neutral float-left" title="Dicom Series Reader" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Insight Software Consortium

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>